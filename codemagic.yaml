# codemagic.yaml — Fixed with App Store Connect API Key Reference
workflows:
  ios-testflight:
    name: iOS → TestFlight
    instance_type: mac_mini_m2
    max_build_duration: 90

    environment:
      vars:
        BUNDLE_ID: "com.liondeskdavid.strokesnchokes"
        APP_STORE_CONNECT_KEY_NAME: "Codemagic"   # ← Exact name from Step 2
        ASC_KEY_ID: "FKNBK58HF2"                    # ← Your 10-char Key ID
        ASC_ISSUER_ID: "6c57ab02-4757-49f6-b5d2-462bcca62124"  # ← Your Issuer ID
        ASC_PRIVATE_KEY: |
          -----BEGIN PRIVATE KEY-----
MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgRxl6uZfwstvpjV5C
b77vae9S/eRPHKpXf2owQGW6N0OgCgYIKoZIzj0DAQehRANCAAQ6lj4+C9X1AZD+
UltpaT9qBkjduspj+4hai1F0zzLMn9q+QL5+tfxqJPo7h53RuyAfCvivFb9yzMeq
aXMrtYdN
-----END PRIVATE KEY-----

      node: latest
      xcode: latest

    triggering:
      events:
        - push
        - tag
      branch_patterns:
        - pattern: main
          include: true

    scripts:
      - name: Install npm dependencies
        script: |
          npm ci --prefer-offline

      - name: Build web assets (Vite)
        script: |
          npm run build

      - name: Capacitor sync iOS
        script: |
          npx cap sync ios

      - name: Install CocoaPods
        script: |
          cd ios/App
          pod install --repo-update

      - name: Increment build number
        script: |
          cd ios/App
          agvtool new-version -all $(($(app-store-connect get-latest-testflight-build-number "$BUNDLE_ID") + 1))

      - name: Build IPA for TestFlight
        script: |
          xcode-project build-ipa \
            --workspace "ios/App/strokesnchokes.xcworkspace" \
            --scheme "strokesnchokes" \
            --export-options-plist "ios/exportOptions.plist"

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      app_store_connect:
        api_key: FKNBK58HF2   # References the key from Step 2
        submit_to_testflight: true
        submit_to_app_store: false