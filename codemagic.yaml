# codemagic.yaml — FINAL WORKING VERSION (Dec 2025)
workflows:
  ios-testflight:
    name: iOS → TestFlight
    instance_type: mac_mini_m2
    max_build_duration: 90

    environment:
      vars:
        BUNDLE_ID: "com.liondeskdavid.strokesnchokes"
        ASC_KEY_ID: "FKNBK58HF2"  # ← Your 10-char Key ID
        ASC_ISSUER_ID: "6c57ab02-4757-49f6-b5d2-462bcca62124"  # ← Your Issuer ID
        # The key content should be stored as a SECRET in Codemagic UI.
        APP_STORE_PRIVATE_KEY: "API_KEY_CONTENT_SECRET"
       
      node: latest
      xcode: latest

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true

    scripts:
      - name: Install dependencies
        script: |
          npm ci

      - name: Build web assets
        script: |
          npm run build

      - name: Capacitor sync iOS
        script: |
          npx cap sync ios

      - name: Install CocoaPods
        script: |
          cd ios/App && pod install

      - name: Build IPA (Correct workspace + export options)
        script: |
          # Generate correct exportOptions.plist for TestFlight
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>TAU24Q4HV5</string>
          </dict>
          </plist>
          EOF

          # Build IPA with correct paths
          xcodebuild -workspace "ios/App/App.xcworkspace" \
                     -scheme "App" \
                     -configuration Release \
                     -archivePath "build/App.xcarchive" \
                     archive

          xcodebuild -exportArchive \
                     -archivePath "build/App.xcarchive" \
                     -exportOptionsPlist exportOptions.plist \
                     -exportPath "build/ipa" \
                     -allowProvisioningUpdates

    artifacts:
      - build/ipa/*.ipa

    publishing:
      app_store_connect:
        auth:
          api_key_id: $ASC_KEY_ID
          issuer_id: $ASC_ISSUER_ID
          private_key: $APP_STORE_CONNECT_PRIVATE_KEY
        submit_to_testflight: true